<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Inventory Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --green: #10b981;
            --green-glow: rgba(16, 185, 129, 0.6);
        }

        [data-theme="light"] {
            --bg-main: #f1f5f9; /* slate-100 */
            --bg-card: #ffffff;
            --bg-header: #ffffff;
            --bg-hover: #f8fafc; /* slate-50 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --border-color: #e2e8f0; /* slate-200 */
            --primary: #4f46e5; /* indigo-600 */
            --primary-hover: #4338ca; /* indigo-700 */
            --danger: #dc2626; /* red-600 */
            --danger-hover: #b91c1c; /* red-700 */
        }

        [data-theme="dark"] {
            --bg-main: #0f172a; /* slate-900 */
            --bg-card: #1e293b; /* slate-800 */
            --bg-header: #1e293b; /* slate-800 */
            --bg-hover: #334155; /* slate-700 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --border-color: #334155; /* slate-700 */
            --primary: #6366f1; /* indigo-500 */
            --primary-hover: #4f46e5; /* indigo-600 */
            --danger: #f87171; /* red-400 */
            --danger-hover: #ef4444; /* red-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            padding-top: 64px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: var(--bg-header);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            height: 64px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .header-content { display: flex; align-items: center; gap: 1.5rem; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) { .container { grid-template-columns: 2fr 1fr; } }

        .main-content { display: grid; grid-auto-rows: min-content; gap: 1.5rem; }

        .card {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .rj45-port {
            position: relative;
            width: 100%;
            padding-top: 100%;
            background-color: #334155;
            border-radius: 0.25rem;
            border-bottom: 4px solid #0f172a;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .rj45-port:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 0 2px var(--primary); }
        .rj45-port::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 30%; background: linear-gradient(to bottom, #94a3b8, #cbd5e1); border-top-left-radius: 0.25rem; border-top-right-radius: 0.25rem; }
        .port-number { position: absolute; bottom: 4px; left: 0; right: 0; text-align: center; font-size: 0.65rem; font-weight: 600; color: #f1f5f9; z-index: 10; }
        .port-light { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; background-color: #64748b; border-radius: 50%; border: 1px solid #334155; transition: all 0.2s ease; }
        .port-light.active { background-color: var(--green); box-shadow: 0 0 5px var(--green), 0 0 10px var(--green-glow); }
        
        .sidebar {
            background-color: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            position: sticky;
            top: calc(64px + 1.5rem);
            align-self: start;
            max-height: calc(100vh - 64px - 3rem);
            overflow-y: auto;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .sidebar-table-container { border: 1px solid var(--border-color); border-radius: 0.5rem; overflow-x: auto; }
        .sidebar-table th { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); background-color: var(--bg-hover); text-align: left; }
        .sidebar-table td { padding: 0.75rem 1rem; font-size: 0.875rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .sidebar-table tbody tr:nth-child(even) { background-color: var(--bg-hover); }
        .table-cell-editable { cursor: pointer; }
        .table-cell-editable:focus { background-color: rgba(var(--primary), 0.1); outline: 2px solid var(--primary); outline-offset: -1px; }

        .port-details-popup {
            position: absolute; z-index: 1100; background-color: #1e293b; color: #f8fafc; border: 1px solid #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); border-radius: 0.5rem; padding: 0.75rem; width: 240px;
            pointer-events: none; display: none; font-size: 0.8rem; line-height: 1.5;
        }
        .port-details-popup h5 { font-weight: 700; margin-bottom: 0.5rem; font-size: 0.9rem; color: #ffffff; }
        .port-details-popup p { color: #cbd5e1; margin-bottom: 0.25rem; }
        .port-details-popup strong { color: #94a3b8; }

        .tab-bar { display: flex; align-items: center; gap: 0.5rem; }
        .tab { padding: 0.5rem 1rem; cursor: pointer; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); background-color: transparent; border-radius: 0.375rem; transition: all 0.2s ease; }
        .tab:hover { background-color: var(--bg-hover); color: var(--primary); }
        .tab.active { color: #ffffff; background-color: var(--primary); }
        
        .editable-title-input { outline: none; border: none; background: transparent; font-size: 1.25rem; font-weight: 600; color: var(--text-primary); padding: 2px; margin: -2px; width: 100%; border-radius: 4px; }
        .editable-title-input:focus { background-color: var(--bg-hover); }
        .editable-office-title { font-size: 0.875rem; font-weight: 600; color: inherit; padding: 0; margin: 0; background: transparent; outline: none; border: none; text-align: center; }
        
        .add-tab-button {
            display: flex; align-items: center; justify-content: center; width: 36px; height: 36px;
            background-color: transparent; border: 1px dashed var(--border-color); border-radius: 0.375rem; color: var(--text-secondary); transition: all 0.2s ease;
        }
        .add-tab-button:hover { border-color: var(--primary); color: var(--primary); }

        /* Modal Styles */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .modal-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 1.5rem 2rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* Modal Buttons */
        .modal-button-primary {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .modal-button-primary:hover {
            background-color: var(--primary-hover);
        }
        .modal-button-secondary {
            background-color: var(--bg-hover);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .modal-button-secondary:hover {
            background-color: var(--border-color);
        }
            </style>
</head>
<body onclick="closePopup()">

    <div class="fixed-header">
        <div class="header-content">
            <h1 class="text-2xl font-bold flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" style="color: var(--primary)" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM14 11a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" /></svg>
                <span style="color: var(--text-primary);">Network Inventory</span>
            </h1>
            <div id="office-tabs" class="tab-bar"></div>
        </div>
        <div class="header-actions">
            <button onclick="toggleTheme()" id="theme-toggle" class="p-2 rounded-full" style="background-color: var(--bg-hover); color: var(--text-secondary);" aria-label="Toggle theme">
                </button>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div id="switches" class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Switches</h2>
                    <button onclick="addSwitch()" class="inline-flex items-center gap-2 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 shadow-sm" style="background-color: var(--primary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Switch</button>
                </div>
                <div id="switches-visuals" class="space-y-6"></div>
            </div>
            
            <div id="patch-panels" class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Patch Panels</h2>
                    <button onclick="addPanel()" class="inline-flex items-center gap-2 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 shadow-sm" style="background-color: var(--primary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Panel</button>
                </div>
                <div id="patch-panel-visuals" class="space-y-6"></div>
            </div>

            <div id="routers" class="card">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold">Routers</h2>
                    <button onclick="addRouter()" class="inline-flex items-center gap-2 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 shadow-sm" style="background-color: var(--primary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>New Router</button>
                </div>
                <div id="routers-visuals" class="space-y-6"></div>
            </div>
        </div>

        <div id="details-sidebar" class="sidebar hidden">
            <div class="flex justify-between items-start mb-6">
                <h3 id="sidebar-title" class="text-2xl font-bold"></h3>
                <button onclick="closeSidebar()" class="text-gray-400 hover:text-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="sidebar-table-container" class="sidebar-table-container">
                <table class="min-w-full sidebar-table">
                    <thead id="sidebar-table-header" class="sticky top-0 z-10"></thead>
                    <tbody id="sidebar-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="port-popup" class="port-details-popup"></div>
    <div id="switch-config-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">Configure New Switch</h3>
            <p class="mb-6" style="color: var(--text-secondary);">Choose the number of ports for the new network switch.</p>
            <div class="flex justify-center gap-3">
                <button id="modal-create-16" class="modal-button-primary">16 Ports</button>
                <button id="modal-create-24" class="modal-button-primary">24 Ports</button>
                <button id="modal-cancel" class="modal-button-secondary">Cancel</button>
            </div>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">Confirm Deletion</h3>
            <p class="mb-6" style="color: var(--text-secondary);">
            Are you sure you want to delete this item? This action cannot be undone.
            </p>
            <div class="flex justify-center gap-3">
            <button id="modal-delete-confirm" 
                    class="font-semibold py-2 px-4 rounded-lg transition-colors duration-200 shadow-sm"
                    style="background-color: var(--danger); color: white;">
                🗑 Delete
            </button>
            <button id="modal-delete-cancel" class="modal-button-secondary">Cancel</button>
            </div>
        </div>
    </div>
    <div id="last-office-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-2">Action Not Allowed</h3>
            <p class="mb-6" style="color: var(--text-secondary);">
            You must keep at least one office in the system. The last office cannot be deleted.
            </p>
            <div class="flex justify-center">
            <button id="modal-last-office-ok" class="modal-button-primary">OK</button>
            </div>
        </div>
    </div>


    <script>
    // --- DATA ---
    let offices = [{
        id: 1, name: 'Main Office',
        switches: [
            { itemId: 1, name: 'Core Switch 1', ports: Array.from({length: 24}, (_, i) => ({ portId: i + 1, pcname: '', department: '', ipAddress: '', mac: '', status: 'inactive', remarks: '' })) },
            { itemId: 2, name: 'Access Switch A-Wing', ports: Array.from({length: 16}, (_, i) => ({ portId: i + 1, pcname: '', department: '', ipAddress: '', mac: '', status: 'inactive', remarks: '' })) }
        ],
        patchPanels: [
            { itemId: 1, name: 'IDF-01 Patch Panel A', ports: Array.from({length: 24}, (_, i) => ({ portId: i + 1, user: '', department: '', pcname: '', location: '', status: 'inactive', remarks: '' })) }
        ],
        routers: [
            { itemId: 1, name: 'Edge Router', ports: Array.from({length: 8}, (_, i) => ({ portId: i + 1, interface: `Gi0/${i}`, ipAddress: '', subnet: '', status: 'inactive', remarks: '' })) }
        ]
    }];
    let activeOfficeId = 1;

    // --- INITIALIZATION ---
    function initializeWithSampleData() {
        const office = offices[0];
        // Sample Switch Data
        office.switches[0].ports[0] = { portId: 1, pcname: 'SRV-DC01', department: 'IT', ipAddress: '192.168.1.10', mac: '0A-1B-2C-3D-4E-5F', status: 'active', remarks: 'Domain Controller' };
        office.switches[0].ports[1] = { portId: 2, pcname: 'SRV-FS01', department: 'IT', ipAddress: '192.168.1.11', mac: '0A-1B-2C-3D-4E-6A', status: 'active', remarks: 'File Server' };
        office.switches[1].ports[4] = { portId: 5, pcname: 'FIN-PC05', department: 'Finance', ipAddress: '192.168.2.25', mac: '0B-2C-3D-4E-5F-7B', status: 'active', remarks: '' };
        // Sample Patch Panel Data
        office.patchPanels[0].ports[0] = { portId: 1, user: 'John Doe', department: 'IT', pcname: 'IT-DEV01', location: 'A-101', status: 'active', remarks: 'Dev machine' };
        office.patchPanels[0].ports[1] = { portId: 2, user: 'Jane Smith', department: 'HR', pcname: 'HR-PC01', location: 'B-203', status: 'active', remarks: 'Manager' };
        // Sample Router Data
        office.routers[0].ports[0] = { portId: 1, interface: 'Gi0/0', ipAddress: '203.0.113.1', subnet: '255.255.255.252', status: 'active', remarks: 'ISP Uplink' };
        office.routers[0].ports[1] = { portId: 2, interface: 'Gi0/1', ipAddress: '192.168.1.1', subnet: '255.255.255.0', status: 'active', remarks: 'Internal LAN' };

        renderAll();
        renderTabs();
    }

    // --- THEME ---
    const themeToggle = document.getElementById('theme-toggle');
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zM11 17a1 1 0 10-2 0v1a1 1 0 102 0v-1z"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>`;
    
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
        localStorage.setItem('theme', theme);
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    }
    
    // --- MODAL CONTROLS ---
    const switchModal = document.getElementById('switch-config-modal');

    function showSwitchModal() {
        switchModal.classList.add('visible');
    }

    function hideSwitchModal() {
        switchModal.classList.remove('visible');
    }

    // --- CRUD & RENDER ---
    const getActiveOffice = () => offices.find(o => o.id === activeOfficeId);

    function renderAll() {
        const office = getActiveOffice();
        if (!office) {
            document.getElementById('switches-visuals').innerHTML = '';
            document.getElementById('patch-panel-visuals').innerHTML = '';
            document.getElementById('routers-visuals').innerHTML = '';
            return;
        }
        renderGeneric('switches', office.switches, 'switches-visuals', 'View Connections');
        renderGeneric('patchPanels', office.patchPanels, 'patch-panel-visuals', 'View Details');
        renderGeneric('routers', office.routers, 'routers-visuals', 'View Config');
    }

    function renderGeneric(type, items, containerId, buttonText) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'rounded-lg p-4';
            itemDiv.style.backgroundColor = 'var(--bg-hover)';
            itemDiv.style.border = '1px solid var(--border-color)';

            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex justify-between items-center mb-4 gap-2';

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'editable-title-input';
            titleInput.value = item.name;
            titleInput.onblur = (e) => updateItemName(type, item.itemId, e.target.value);
            
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'flex items-center gap-2 flex-shrink-0';
            buttonsDiv.innerHTML = `
                <button onclick="openSidebar('${type}', ${item.itemId})" class="text-white font-semibold py-1 px-3 rounded-full text-xs transition-colors" style="background-color: var(--primary);">${buttonText}</button>
                <button onclick="deleteItem('${type}', ${item.itemId})" class="text-white font-semibold p-1.5 rounded-full text-xs transition-colors" style="background-color: var(--danger);"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>
            `;
            
            headerDiv.appendChild(titleInput);
            headerDiv.appendChild(buttonsDiv);
            itemDiv.appendChild(headerDiv);

            const grid = document.createElement('div');
            const cols = item.ports.length > 16 ? 12 : 8;
            grid.className = `grid grid-cols-6 sm:grid-cols-8 md:grid-cols-${cols} gap-3`;
            item.ports.forEach(port => {
                const portDiv = document.createElement('div');
                portDiv.className = 'rj45-port';
                portDiv.innerHTML = `<span class="port-number">${port.portId}</span><div class="port-light ${port.status === 'active' ? 'active' : ''}"></div>`;
                portDiv.onclick = (e) => { e.stopPropagation(); showPortDetailsPopup(e, type, item.itemId, port.portId); };
                grid.appendChild(portDiv);
            });
            itemDiv.appendChild(grid);
            container.appendChild(itemDiv);
        });
    }

    function createSwitch(portCount) {
        const office = getActiveOffice();
        if (!office) return;

        const nextId = (office.switches.length > 0 ? Math.max(...office.switches.map(s => s.itemId)) : 0) + 1;
        const newSwitch = { 
            itemId: nextId, 
            name: `Switch ${nextId}`, 
            ports: Array.from({ length: portCount }, (_, i) => ({ 
                portId: i + 1, pcname: '', department: '', ipAddress: '', mac: '', status: 'inactive', remarks: '' 
            })) 
        };
        
        office.switches.push(newSwitch);
        renderAll();
        hideSwitchModal();
    }
    
    function addSwitch() {
        showSwitchModal();
    }

    function addPanel() {
        const office = getActiveOffice();
        const nextId = (office.patchPanels.length > 0 ? Math.max(...office.patchPanels.map(p => p.itemId)) : 0) + 1;
        const newPanel = { itemId: nextId, name: `Patch Panel ${nextId}`, ports: [] };
        for (let i = 1; i <= 24; i++) {
            newPanel.ports.push({ portId: i, user: '', department: '', pcname: '', location: '', status: 'inactive', remarks: '' });
        }
        office.patchPanels.push(newPanel);
        renderAll();
    }

    function addRouter() {
        const office = getActiveOffice();
        const nextId = (office.routers.length > 0 ? Math.max(...office.routers.map(r => r.itemId)) : 0) + 1;
        const newRouter = { itemId: nextId, name: `Router ${nextId}`, ports: [] };
        for (let i = 1; i <= 8; i++) {
            newRouter.ports.push({ portId: i, interface: `Gi0/${i-1}`, ipAddress: '', subnet: '', status: 'inactive', remarks: '' });
        }
        office.routers.push(newRouter);
        renderAll();
    }

    let pendingDelete = { type: null, itemId: null };

    function deleteItem(type, itemId) {
        if (type === 'offices' && offices.length === 1) {
            // Show warning modal instead of deleting
            document.getElementById('last-office-modal').classList.add('visible');
            return;
        }

        // Store what to delete and show delete confirmation modal
        pendingDelete = { type, itemId };
        document.getElementById('delete-confirm-modal').classList.add('visible');
    }


    function confirmDelete() {
        const { type, itemId } = pendingDelete;
        if (!type || !itemId) return;

        if (type === 'offices') {
            offices = offices.filter(o => o.id !== itemId);

            // Switch to first office if deleted active one
            if (activeOfficeId === itemId && offices.length > 0) {
            activeOfficeId = offices[0].id;
            }

            renderAll();
            renderTabs();
            closeDeleteModal();
            return;
        }

        // Existing logic for switches, panels, routers...
        const office = getActiveOffice();
        office[type] = office[type].filter(item => item.itemId !== itemId);
        
        const sidebar = document.getElementById('details-sidebar');
        if (!sidebar.classList.contains('hidden') && sidebar.dataset.type === type && sidebar.dataset.itemId == itemId) {
            closeSidebar();
        }

        renderAll();
        closeDeleteModal();
    }

    function closeDeleteModal() {
        document.getElementById('delete-confirm-modal').classList.remove('visible');
        pendingDelete = { type: null, itemId: null };
    }
    
    function updateItemName(type, itemId, newName) {
        if (!newName.trim()) {
            renderAll(); // Re-render to restore original name if input is empty
            return;
        };
        const item = getActiveOffice()[type].find(i => i.itemId === itemId);
        if (item) item.name = newName.trim();
    }

    function updateData(type, itemId, portId, field, newValue) {
        const item = getActiveOffice()[type].find(i => i.itemId == itemId);
        if (item) {
            const port = item.ports.find(p => p.portId == portId);
            if (port) port[field] = newValue;
        }
    }

    function toggleStatus(type, itemId, portId) {
        const port = getActiveOffice()[type].find(i => i.itemId == itemId).ports.find(p => p.portId == portId);
        if (port) {
            port.status = port.status === 'active' ? 'inactive' : 'active';
            renderAll(); 
            openSidebar(type, itemId); 
        }
    }
    
    // --- TABS & SIDEBAR ---
    function renderTabs() {
        const tabsContainer = document.getElementById('office-tabs');
        tabsContainer.innerHTML = '';

        offices.forEach(office => {
            const tab = document.createElement('div');
            tab.className = `tab flex items-center gap-2 ${office.id === activeOfficeId ? 'active' : ''}`;
            tab.onclick = () => switchOffice(office.id);

            // Editable office name
            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'editable-office-title';
            titleInput.value = office.name;
            titleInput.readOnly = true;
            titleInput.style.width = `${office.name.length}ch`;

            titleInput.addEventListener('click', (e) => {
                e.stopPropagation();
                titleInput.readOnly = false;
                titleInput.focus();
            });

            const saveName = () => {
                titleInput.readOnly = true;
                if (titleInput.value.trim() !== '') {
                    office.name = titleInput.value.trim();
                    titleInput.style.width = `${office.name.length}ch`;
                } else {
                    titleInput.value = office.name;
                }
            };

            titleInput.addEventListener('blur', saveName);
            titleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    titleInput.blur();
            }
            });
            titleInput.addEventListener('input', () => {
                titleInput.style.width = `${Math.max(5, titleInput.value.length)}ch`;
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
            deleteBtn.className = "p-1.5 rounded-full transition-colors";
            deleteBtn.style.backgroundColor = "var(--danger)";
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteItem('offices', office.id);
            };

            tab.appendChild(titleInput);
            tab.appendChild(deleteBtn);

            tabsContainer.appendChild(tab);
        });

        const addButton = document.createElement('button');
        addButton.className = 'add-tab-button';
        addButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>`;
        addButton.onclick = addOfficeTab;
        tabsContainer.appendChild(addButton);
    }

    function switchOffice(id) { 
        activeOfficeId = id; 
        renderAll(); 
        renderTabs(); 
        closeSidebar(); 
    }
    
    function addOfficeTab() {
        const nextId = offices.length > 0 ? Math.max(...offices.map(o => o.id)) + 1 : 1;
        const newOffice = {
            id: nextId,
            name: `Office ${nextId}`,
            switches: [],
            patchPanels: [],
            routers: []
        };
        
        offices.push(newOffice);
        switchOffice(nextId);
    }
    
    function openSidebar(type, itemId) {
        const sidebar = document.getElementById('details-sidebar');
        const item = getActiveOffice()[type].find(i => i.itemId == itemId);
        if (!item) return;

        sidebar.classList.remove('hidden');
        sidebar.dataset.type = type;
        sidebar.dataset.itemId = itemId;
        document.getElementById('sidebar-title').innerText = item.name;

        let headers, portFields;
        switch(type) {
            case 'switches':
                headers = ['Port', 'PC Name', 'Dept.', 'IP Address', 'MAC', 'Status', 'Remarks'];
                portFields = ['pcname', 'department', 'ipAddress', 'mac'];
                break;
            case 'patchPanels':
                headers = ['Port', 'User', 'Dept.', 'PC Name', 'Location', 'Status', 'Remarks'];
                portFields = ['user', 'department', 'pcname', 'location'];
                break;
            case 'routers':
                headers = ['Port', 'Interface', 'IP Address', 'Subnet', 'Status', 'Remarks'];
                portFields = ['interface', 'ipAddress', 'subnet'];
                break;
        }

        document.getElementById('sidebar-table-header').innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
        const body = document.getElementById('sidebar-table-body');
        body.innerHTML = '';
        item.ports.forEach(port => {
            const tr = document.createElement('tr');
            let cells = `<td>${port.portId}</td>`;
            portFields.forEach(field => {
                cells += `<td class="table-cell-editable" data-field="${field}" contenteditable="true">${port[field] || ''}</td>`;
            });
            cells += `
                <td><button onclick="toggleStatus('${type}', ${itemId}, ${port.portId})" class="text-white text-xs font-bold py-1 px-3 rounded-full ${port.status === 'active' ? 'bg-green-500' : 'bg-gray-400'}">${port.status}</button></td>
                <td class="table-cell-editable" data-field="remarks" contenteditable="true">${port.remarks || ''}</td>`;
            tr.innerHTML = cells;
            tr.dataset.portId = port.portId;
            body.appendChild(tr);
        });
        
        body.querySelectorAll('.table-cell-editable').forEach(cell => {
            cell.addEventListener('blur', e => {
                const row = e.target.closest('tr');
                updateData(type, itemId, row.dataset.portId, e.target.dataset.field, e.target.innerText.trim());
            });
        });
    }

    function closeSidebar() { document.getElementById('details-sidebar').classList.add('hidden'); }
    
    // --- POPUP ---
    function closePopup() { 
        const popup = document.getElementById('port-popup');
        if (popup) {
            popup.style.display = 'none';
        }
    }
    
    function showPortDetailsPopup(e, type, itemId, portId) {
        const popup = document.getElementById('port-popup');
        const activeOffice = getActiveOffice();
        const item = activeOffice[type].find(i => i.itemId == itemId);
        const port = item.ports.find(p => p.portId == portId);
        
        const rect = e.currentTarget.getBoundingClientRect();
        let content = '';

        switch(type) {
            case 'switches':
                content = `
                    <p><strong>PC Name:</strong> ${port.pcname || 'N/A'}</p>
                    <p><strong>Department:</strong> ${port.department || 'N/A'}</p>
                    <p><strong>IP Address:</strong> ${port.ipAddress || 'N/A'}</p>
                    <p><strong>MAC:</strong> ${port.mac || 'N/A'}</p>
                `;
                break;
            case 'patchPanels':
                content = `
                    <p><strong>User:</strong> ${port.user || 'N/A'}</p>
                    <p><strong>Department:</strong> ${port.department || 'N/A'}</p>
                    <p><strong>PC Name:</strong> ${port.pcname || 'N/A'}</p>
                    <p><strong>Location:</strong> ${port.location || 'N/A'}</p>
                `;
                break;
            case 'routers':
                content = `
                    <p><strong>Interface:</strong> ${port.interface || 'N/A'}</p>
                    <p><strong>IP Address:</strong> ${port.ipAddress || 'N/A'}</p>
                    <p><strong>Subnet:</strong> ${port.subnet || 'N/A'}</p>
                `;
                break;
        }
        
        popup.innerHTML = `
            <h5>${item.name} - Port ${port.portId}</h5>
            <p><strong>Status:</strong> <span style="font-weight: bold; color: ${port.status === 'active' ? 'var(--green)' : '#94a3b8'};">${port.status}</span></p>
            ${content}
            <p><strong>Remarks:</strong> ${port.remarks || 'N/A'}</p>
        `;
        
        popup.style.display = 'block';
        
        const topPosition = rect.bottom + window.scrollY + 8;
        const leftPosition = rect.left + window.scrollX + (rect.width / 2) - (popup.offsetWidth / 2);
        
        popup.style.left = `${Math.max(8, leftPosition)}px`;
        popup.style.top = `${topPosition}px`;
    }

    // --- LIFECYCLE ---
    document.addEventListener('DOMContentLoaded', () => {
        // Theme initialization
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);
        
        // Data initialization
        initializeWithSampleData();

        // Modal event listeners
        document.getElementById('modal-create-16').addEventListener('click', () => createSwitch(16));
        document.getElementById('modal-create-24').addEventListener('click', () => createSwitch(24));
        document.getElementById('modal-cancel').addEventListener('click', hideSwitchModal);
        document.getElementById('modal-delete-confirm').addEventListener('click', confirmDelete);
        document.getElementById('modal-delete-cancel').addEventListener('click', closeDeleteModal);

        const lastOfficeModal = document.getElementById('last-office-modal');
        document.getElementById('modal-last-office-ok').addEventListener('click', () => {
            lastOfficeModal.classList.remove('visible');
        });

        lastOfficeModal.addEventListener('click', (event) => {
        if (event.target === lastOfficeModal) {
            lastOfficeModal.classList.remove('visible');
        }
        });

        const deleteModal = document.getElementById('delete-confirm-modal');
        deleteModal.addEventListener('click', (event) => {
        if (event.target === deleteModal) {
            closeDeleteModal();
        }
        });

        switchModal.addEventListener('click', (event) => {
            if (event.target === switchModal) {
                hideSwitchModal();
            }
        });
    });
</script>
</body>
</html>